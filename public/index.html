<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>WebSocket 테스트</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2> WebSocket 테스트</h2>
  <canvas id="coinChart" width="600" height="300"></canvas>
  <input id="message" placeholder="보낼 메시지 입력" />
  <button onclick="sendMessage()">전송</button>

  <div id="log" style="margin-top: 20px;"></div>

  <script>
    const socket = new WebSocket("ws://localhost:3000");

    const labels = [];
    const prices = [];

    const ctx = document.getElementById('coinChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'BTC 가격',
          data: prices,
          borderWidth: 2,
          borderColor: 'blue',
          fill: false
        }]
      },
      options: {
        responsive: true,
        animation: false,
        scales: {
          x: { title: { display: true, text: '시간' }},
          y: { title: { display: true, text: '가격' }}
        }
      }
    });

    socket.onopen = () => {
      log(" 연결 성공");
    };

    socket.onmessage = (event) => {
    //   log(" 받은 메시지: " + event.data);
    const msg = JSON.parse(event.data);

      if (msg.type === "COIN_UPDATE") {
        const now = new Date().toLocaleTimeString();
        const price = msg.data.price;

        labels.push(now);
        prices.push(price);

        if (labels.length > 20) {
          labels.shift();
          prices.shift();
        }

        chart.update();
      }
    };

    socket.onclose = () => {
      log(" 연결 종료됨");
    };

    function sendMessage() {
      const input = document.getElementById("message");
      const message = input.value;
      socket.send(message);
      log(" 보낸 메시지: " + message);
      input.value = '';
    }

    function log(text) {
      const div = document.getElementById("log");
      div.innerHTML += `<div>${text}</div>`;
    }
  </script>
</body>
</html>
